# A log-Gaussian Cox Process {#lgcp}

A Log-Gaussian Cox Process (LGCP) is a doubly stochastic spatial point process. In the simplest case, the intensity of the point process over space is given by:
$$\Lambda(s) = \text{exp}(\beta_0 + G(s) + \epsilon)$$
where $\beta_0$ is a constant, known as the intercept, $G(s)$ is a Gaussian Markov Random Field (GMRF) and $\epsilon$ an error term. 

It is conventional to use Mat√©rn covariance function to define the covariance of the random field. This takes two parameters $\tau$ and $\kappa$, commonly reported as $r=\frac{\sqrt{8}}{\kappa}$ and $\sigma=\frac{1}{\sqrt{4\pi\kappa^2\tau^2}}$, where $r$ is the range and $\sigma$ is the standard deviation. 

## The `fit_lgcp()` function

```{r}
args(fit_lgcp)
```

## Fitting a LGCP

### Spatial only

```{r}
require(maptools)
data(xyt, package = "stelfi")
domain <- as(xyt$window, "SpatialPolygons")
locs <- data.frame(x = xyt$x, y = xyt$y)
smesh <- INLA::inla.mesh.2d(boundary = INLA::inla.sp2segment(domain), 
                      max.edge = 0.75, cutoff = 0.3)
system.time(fit <- fit_lgcp(locs = locs, sp = domain, smesh = smesh,
                            parameters = c(beta = 0, log_tau = log(1), log_kappa = log(1))))
get_coefs(fit)
```

```{r}
plot_lambda(fit, smesh = smesh, border = domain) +
    ggplot2::theme_void()
```

**Comparing to `inlabru`**

```{r}
require(inlabru)
require(ggplot2)
matern <- INLA::inla.spde2.matern(smesh)
cmp <- coordinates ~ mySmooth(coordinates, model = matern) + Intercept(1)
coordinates(locs) <- c("x", "y")
system.time(fit_inla <- lgcp(cmp, locs,
                             samplers = domain,
                             domain = list(coordinates = smesh),
                             options = list(control.inla = list(int.strategy = "eb"))))
summary(fit_inla)
```

```{r, echo = FALSE, results = 'asis'}
lambda <- predict(fit_inla, pixels(smesh), ~ exp(mySmooth + Intercept))
ggplot() +
    gg(lambda) +
    gg(domain) +
    coord_fixed() +
    scale_fill_viridis_c() +
    theme_void()


```

### Spatiotemporal LGCP
The LGCP model can also be used for spatiotemporal modelling where there is autoregressive temporal dependence. 

To achieve this, we choose an arbitrary number of time knots. The equation for an AR(1) process is as follows:
$$\Lambda_i(s) = \text{exp}(\beta_0 + G_i(s) + \epsilon)$$
where $i$ indexes the time knot. $\Lambda_i(s)$ is the field intensity at time knot $i$, and $G_i(s)$ the GMRF at the same time knot. Each $G_i(s)$ shares common values for $\tau$ and $\kappa$. 

Successive random fields are correlated through the formula
$$G_i(s)=\rho G_{i-1}(s) + \epsilon_i$$
where $\rho$ is a constant between -1 and +1, and $\epsilon_i$ is normally distributed with mean 0. 
```{r}
ndays <- 2
locs <- data.frame(x = xyt$x, y = xyt$y, t = xyt$t)
w0 <- 2
tmesh <- INLA::inla.mesh.1d(seq(0, ndays, by = w0))
fit <- fit_lgcp(locs = locs, sp = domain, smesh = smesh, tmesh = tmesh,
                parameters = c(beta = 0, log_tau = log(1), log_kappa = log(1), atanh_rho = 0.2))
get_coefs(fit)
```


```{r}

plot_lambda(fit, smesh = smesh, tmesh = tmesh, timestamp = 1) +
    ggplot2::theme_void() + ggplot2::ggtitle("t = 2")
plot_lambda(fit, smesh = smesh, tmesh = tmesh, timestamp = 2) +
    ggplot2::theme_void() + ggplot2::ggtitle("t = 2")

```

### Simulating a spatiotemporal LGCP

**Option 1** using `simulate_lgcp`

```{r}
parameters <- c(beta = 1, log_tau = log(1), log_kappa = log(1), atanh_rho = 0.2)
simdata <- simulate_lgcp(parameters = parameters, sp = domain, smesh = smesh, tmesh = tmesh)
show_field(simdata$x[,1], smesh = smesh) +
    ggplot2::theme_void()
```

**Option 2** directly from the fitted model

```{r}
simdata <- fit$simulate(fit$env$last.par, complete = FALSE)
show_field(simdata$x[,1], smesh = smesh) +
    ggplot2::theme_void()
```

### Spatial LGCP with covariates
We may wish to assign a scalar or vector covariate to the mesh and ascertain the relationship between the covariate and the intensity. 
A LGCP with covariates has an intensity function of the form:
$$\Lambda(s) = \text{exp}(\Sigma \beta C + G(s) + \epsilon)$$
where $C$ is the matrix of covariates and $\beta$ the coefficients that multiply the covariates. The first column of $C$ should be ones, so that the first element of $beta$ is an intercept. 