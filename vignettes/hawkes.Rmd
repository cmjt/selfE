---
title: "Fitting a Hawkes process"
author: "Charlotte M. Jones-Todd"
date: ""
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting a Hawkes process}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE,message=FALSE,results='asis'}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE,cache = TRUE, message = FALSE, warning = FALSE)
```

Before using the  `TMB` templates in `stelfi` you should use `compile_stelfi()` to compile them:

```{r library,results='hide',message=FALSE}
library(stelfi)
```

```{r compile, eval = FALSE}
compile_stelfi()
```

## Fitting a Hawkes process model


### Modelling Twitter data

A [NIWA](https://niwa.co.nz/) scientist [found a working USB in the scat of a leopard seal](https://www.nzherald.co.nz/nz/news/article.cfm?c_id=1&objectid=12201147), they then [tweeted about it](https://twitter.com/niwa_nz/status/1092610541401587712) in the hopes of finding its owner.

```{r data,message=FALSE}
data(retweets_niwa)
head(retweets_niwa)
```

```{r sort data}
## numeric time stamps
times <- sort(as.numeric(difftime(retweets_niwa ,min(retweets_niwa),units = "mins")))
```


```{r plot hist, echo = FALSE, fig.cap = "Observed counts of retweet times.",fig.height = 5,fig.width = 8}
# NIWA seal first tweet according to Twitter
start <- lubridate::ymd_hms("2019-02-05 02:27:07")
## NIWA seal found owner tweet according to Twitter
end <- lubridate::ymd_hms("2019-02-07 06:50:08")
## hist
hist(retweets_niwa, breaks = "hours", axes = FALSE, 
     xlab = "", ylab = "",main = "", col = "grey",border = "grey",freq = TRUE)
axis(2,at = c(0,250))
mtext(2, line = 0, text = "Number of retweets per hour",cex = 0.8)
mtext(1,line = 1, at = c(start,end),text = c("NIWA \n tweeted","USB owner \n found"),cex = 0.9)
```



```{r fit model,results = 'hide',cache = TRUE}
params <- c(mu = 9, alpha = 3, beta = 10)
## must have compiled TMB templates first use compile_stelfi()
fit <- fit_hawkes(times = times,parameters = params) 
```


```{r params}
## print out estimated parameters
pars <- get_coefs(fit)
pars
```



```{r plot, echo = TRUE,fig.height = 7,fig.width = 9,fig.cap="Fitted intensity (top plot) and observed counts of retweets (bottom)."}
show_hawkes(times = times, mu = pars[1,1], alpha = pars[2,1], beta = pars[3,1])
```

### Modelling UK serial killer data

```{r terrorism}
data(serial_uk)
## make date vector
times <- as.Date(paste(serial_uk$Date.of.first.kill, "/01", sep=''), "%m/%Y/%d")
times <- sort(lubridate::year(times) + lubridate::month(times)/12 - lubridate::year(min(times)))
```



```{r fit model mud,results = 'hide',cache = TRUE}
params <- c(mu = 0.06,alpha = 0.006,beta = 0.01)
## must have compiled TMB templates first use compile_stelfi()
fit <- fit_hawkes(times = times,parameters = params) 
```

```{r params terr}
## print out estimated parameters
pars <- get_coefs(fit)
pars
```

```{r plot2, echo = TRUE,fig.height = 7,fig.width = 9,fig.cap="Fitted intensity (top plot) and observed counts of UK serial murderers (bottom)."}
show_hawkes(times = times, mu = pars[1,1], alpha = pars[2,1], beta = pars[3,1])
```

### Modelling malaria data

Here we consider data from [*Using Hawkes Processes to model imported and local malaria cases in near-elimination settings*](https://dx.doi.org/10.1371%2Fjournal.pcbi.1008830). Data are recorded line lists of individuals with malaria (caused by the *Plasmodium vivax* parasite) in Yunnan Province, China between 1st January 2011 to 24th September 2013. Data may be downloaded from [here](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/YPRLIL) as follows.

```{r china data, echo = TRUE, message = FALSE, eval = FALSE}
tmp <- tempfile(fileext = ".RData")
download.file("https://dataverse.harvard.edu/api/access/datafile/4443458",
              destfile = tmp)
load(tmp)
unlink(tmp)
```

```{r, eval = TRUE, echo = FALSE}
load("../data/china_malaria.RData")
```


```{r china EDA}
str(china_malaria)
times <- china_malaria$time_jitter
```

```{r fit model china,results = 'hide',cache = TRUE}
params <- c(mu = 9, alpha = 3, beta = 10)
## must have compiled TMB templates first use compile_stelfi()
fit <- fit_hawkes(times = times,parameters = params) 
```

```{r params china}
## print out estimated parameters
pars <- get_coefs(fit)
pars
```

```{r plot3, echo = TRUE,fig.height = 7,fig.width = 9,fig.cap="Fitted intensity (top plot) and observed counts of recorded malarial infection (bottom)."}
show_hawkes(times = times, mu = pars[1,1], alpha = pars[2,1], beta = pars[3,1])
```

## Simulating a Hawkes process

**Set parameters**

```{r}
mu <- 0.25
alpha <- 0.13
beta <- 0.15
```

### Option 1

Simulation algorithm as per [*On Lewis' simulation method for point processes*](https://ieeexplore.ieee.org/document/1056305)

```{r, fig.height = 7,fig.width = 9,}
sim1 <- sim_hawkes(mu = mu, alpha = alpha, beta = beta, plot = TRUE)
```

### Option 2

Simulation algorithm as per [*MLE of Hawkes' self-exciting point process*]({https://radhakrishna.typepad.com/mle-of-hawkes-self-exciting-process.pdf)

```{r, fig.height = 7,fig.width = 9,}
sim2 <- sim_hawkes(mu = mu, alpha = alpha, beta = beta,n = 250, method = "2", plot = TRUE)
```

### Option 3

Using the TMB likelihood template; below we simulate another realisation from the fitted `china_malaria` model:

```{r}
sim3 <- fit$simulate()
dplyr::glimpse(sim3)
```
